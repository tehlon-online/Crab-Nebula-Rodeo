<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crab Nebula Rodeo</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #da9617;
            color: white;
            font-family: Arial, sans-serif;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            border: 1px solid white;
            background-color: #da9617;
            width: 90vw;
            height: 90vh;
        }

        .controls {
            margin-top: 10px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls-left {
            display: flex;
            align-items: center;
        }

        .controls-right {
            display: flex;
            align-items: center;
        }

        label {
            margin-right: 5px;
        }

        input {
            margin-right: 10px;
        }

        button {
            margin: 5px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .popup {
            background-color: #222;
            border: 2px solid #ffee00;
            padding: 20px;
            text-align: center;
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 0 20px #ffee00;
        }

        .popup img {
            max-width: 100%;
            height: auto;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .popup button {
            background-color: #ffee00;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            color: #222;
        }

        .popup button:hover {
            background-color: #fff45e;
        }
    </style>
</head>
<body>
    <div class="popup-overlay" id="introPopup">
        <div class="popup">
            <p><em>You are a Space Crab spreading carcinization throughout the universe.</em></p>
            <img src="spacecrab.png" alt="Space Crab">
            <p>Crabify all planets.</p>
            <button id="startGameBtn">Let's Crab</button>
        </div>
    </div>

    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        <div class="controls">
            <div class="controls-left">
                <button id="newSolarSystemBtn">New Solar System</button>
            </div>
            <div class="controls-right">
                <label for="angleInput">Angle (Î¸):</label>
                <input type="number" id="angleInput" min="0" max="360" value="0">
                <label for="powerInput">Power (P):</label>
                <input type="number" id="powerInput" min="0" max="100" value="50">
                <button id="launchButton" disabled>Launch Crab</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const angleInput = document.getElementById('angleInput');
        const powerInput = document.getElementById('powerInput');
        const launchButton = document.getElementById('launchButton');
        const introPopup = document.getElementById('introPopup');
        const startGameBtn = document.getElementById('startGameBtn');
        const newSolarSystemBtn = document.getElementById('newSolarSystemBtn');

        const backgroundImage = new Image();
        backgroundImage.src = 'crabneubula.png';

        let stats = {
            crabsLaunched: 0,
            planetsCrabified: 0,
            crabsLost: 0
        };

        let crab = {
            x: 0,
            y: 0,
            vx: 0,
            vy: 0,
            visible: true,
            launched: false,
            startPlanet: null
        };

        const trail = [];
        const trailLength = 200;
        const planets = [
            { x: 0, y: 0, mass: 5000, radius: 25, color:'#ffee00', hasRings: false }
        ];
        let randomPlanets = [];
        const G = 0.02;
        let animationFrameId;
        let lastFrameTime = 0;

        function updateStatsDisplay() {}

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        function drawStatsBox() {
            const size = 60;
            const padding = 10;
            const rightEdge = canvas.width - padding - size - 40;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            roundRect(ctx, rightEdge, padding, size + 40, size, 5);
            ctx.fill();

            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.font = '10px Arial';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';

            const textX = rightEdge + 10;
            const lineHeight = size / 4;

            ctx.fillText(`Crabs Launched: ${stats.crabsLaunched}`, textX, padding + lineHeight);
            ctx.fillText(`Planets Crabified: ${stats.planetsCrabified}`, textX, padding + lineHeight * 2);
            ctx.fillText(`Crabs Lost: ${stats.crabsLost}`, textX, padding + lineHeight * 3);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth * 0.9;
            canvas.height = window.innerHeight * 0.9;
            planets[0].x = canvas.width / 2;
            planets[0].y = canvas.height / 2;
            resetGame();
            animate(performance.now());
        }

        function resetGame() {
            crab.visible = true;
            crab.launched = false;
            trail.length = 0;

            if (randomPlanets.length === 0) {
                stats = {
                    crabsLaunched: 0,
                    planetsCrabified: 0,
                    crabsLost: 0
                };
                updateStatsDisplay();
                const randomPlanetCount = Math.floor(Math.random() * 7) + 4; // Random number between 4-10
                addRandomPlanets(randomPlanetCount);
            }
        }

        function generateNewSolarSystem() {
            randomPlanets = [];
            stats = {
                crabsLaunched: 0,
                planetsCrabified: 0,
                crabsLost: 0
            };
            updateStatsDisplay();
            const randomPlanetCount = Math.floor(Math.random() * 7) + 4; // Random number between 4-10
            addRandomPlanets(randomPlanetCount);
            resetGame();
        }

        function checkCollisions() {
            if (!crab.launched || !crab.visible) return false;

            const allPlanets = planets.concat(randomPlanets);
            for (let i = 0; i < allPlanets.length; i++) {
                const planet = allPlanets[i];
                if (planet === crab.startPlanet) continue;

                const dx = planet.x - crab.x;
                const dy = planet.y - crab.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (i === 0 && distance < planet.radius + 8) {
                    trail.length = 0;
                    crab.x = crab.startPlanet.x;
                    crab.y = crab.startPlanet.y - crab.startPlanet.radius - 5;
                    crab.visible = true;
                    stats.crabsLost++;
                    updateStatsDisplay();
                    return true;
                }

                if (distance < planet.radius + 8) {
                    if (i >= 1 && !planet.visited) {
                        stats.planetsCrabified++;
                        updateStatsDisplay();
                    }
                    planet.color = 'red';
                    planet.visited = true;
                    crab.startPlanet = planet;

                    crab.x = planet.x;
                    crab.y = planet.y - planet.radius - 5;
                    crab.visible = true;
                    trail.length = 0;
                    return true;
                }
            }
            return false;
        }

        function launchCrab() {
            if (!crab.visible || crab.launched) return;

            stats.crabsLaunched++;
            updateStatsDisplay();

            const angle = parseFloat(angleInput.value) * (Math.PI / 180);
            const power = parseFloat(powerInput.value);
            const speedFactor = getSpeedFactor(power);

            crab.vx = speedFactor * Math.cos(angle);
            crab.vy = -speedFactor * Math.sin(angle);
            crab.launched = true;

            lastFrameTime = performance.now();
            animate(lastFrameTime);
        }

        function getSpeedFactor(power) {
            if (power <= 20) return 0.5;
            if (power <= 40) return 1.0;
            if (power <= 60) return 1.5;
            if (power <= 80) return 2.0;
            return 2.5;
        }

        function applyGravity(deltaTime) {
            const timeScale = deltaTime / 16.67;
            planets.concat(randomPlanets).forEach(planet => {
                if (planet === crab.startPlanet) return;

                const dx = planet.x - crab.x;
                const dy = planet.y - crab.y;
                const distance = Math.sqrt(dx * dx + dy * dy) - planet.radius;
                const force = G * (planet.mass / (distance * distance));
                crab.vx += force * (dx / distance) * timeScale;
                crab.vy += force * (dy / distance) * timeScale;
            });
        }

        function updateCrab(deltaTime) {
            const timeScale = deltaTime / 16.67;
            crab.x += crab.vx * timeScale;
            crab.y += crab.vy * timeScale;
            applyGravity(deltaTime);
        }

        function drawCompassPlaceholder() {
            const size = 60;
            const padding = 10;
            const centerX = padding + size / 2;
            const centerY = padding + size / 2;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(padding, padding, size, size);

            ctx.strokeStyle = 'white';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 35, 0, Math.PI * 2);
            ctx.stroke();

            ctx.font = '10px Arial';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const labelRadius = 30 * 0.7;

            ctx.fillText('0Â°', centerX + labelRadius, centerY);
            ctx.fillText('90Â°', centerX, centerY - labelRadius);
            ctx.fillText('180Â°', centerX - labelRadius, centerY);
            ctx.fillText('270Â°', centerX, centerY + labelRadius);
        }

        function drawCrab() {
            if (crab.visible) {
                ctx.font = '16px serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ðŸ¦€', crab.x, crab.y);
            }
        }

        function drawPlanets() {
            planets.concat(randomPlanets).forEach(planet => {
                ctx.fillStyle = planet.color;
                ctx.beginPath();
                ctx.arc(planet.x, planet.y, planet.radius, 0, Math.PI * 2);
                ctx.fill();

                if (planet.hasRings) {
                    ctx.strokeStyle = 'grey';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(planet.x, planet.y, planet.radius + 5, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(planet.x, planet.y, planet.radius + 2.5, 0, Math.PI * 2);
                    ctx.stroke();
                }
            });
        }

        function drawTrail() {
            ctx.fillStyle = 'white';
            for (let i = 0; i < trail.length; i++) {
                ctx.fillRect(trail[i].x, trail[i].y, 1, 1);
            }
        }

        function addRandomPlanets(count) {
            randomPlanets = [];
            for (let i = 0; i < count; i++) {
                let x, y, tooClose;
                do {
                    x = Math.random() * canvas.width;
                    y = Math.random() * canvas.height;
                    tooClose = false;

                    const dxSun = x - planets[0].x;
                    const dySun = y - planets[0].y;
                    const distSun = Math.sqrt(dxSun * dxSun + dySun * dySun);
                    if (distSun < planets[0].radius + 40) {
                        tooClose = true;
                        continue;
                    }

                    for (const planet of randomPlanets) {
                        const dx = x - planet.x;
                        const dy = y - planet.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 40) {
                            tooClose = true;
                            break;
                        }
                    }
                } while (tooClose);

                randomPlanets.push({
                    x: x,
                    y: y,
                    mass: 500 + Math.random() * 200,
                    radius: 5 + Math.random() * 5,
                    color: 'cyan',
                    visited: false
                });
            }

            const initialPlanet = randomPlanets[0];
            initialPlanet.color = 'red';
            initialPlanet.visited = true;
            crab.x = initialPlanet.x;
            crab.y = initialPlanet.y - initialPlanet.radius - 5;
            crab.visible = true;
            crab.launched = false;
            crab.startPlanet = initialPlanet;
            launchButton.disabled = false;
        }

        function animate(currentTime) {
            const deltaTime = currentTime - lastFrameTime;
            lastFrameTime = currentTime;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (backgroundImage.complete) {
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            }

            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (crab.launched) {
                updateCrab(deltaTime);

                if (checkCollisions() ||
                    crab.x < 0 || crab.x > canvas.width ||
                    crab.y < 0 || crab.y > canvas.height) {
                    cancelAnimationFrame(animationFrameId);
                    crab.launched = false;

                    if (crab.x < 0 || crab.x > canvas.width ||
                        crab.y < 0 || crab.y > canvas.height) {
                        trail.length = 0;
                        crab.x = crab.startPlanet.x;
                        crab.y = crab.startPlanet.y - crab.startPlanet.radius - 5;
                        crab.visible = true;
                        stats.crabsLost++;
                        updateStatsDisplay();
                    }
                } else {
                    trail.push({ x: crab.x, y: crab.y });
                    if (trail.length > trailLength) {
                        trail.shift();
                    }
                }
            }

            drawPlanets();
            drawTrail();
            drawCrab();
            drawCompassPlaceholder();
            drawStatsBox();

            animationFrameId = requestAnimationFrame(animate);
        }

        backgroundImage.onload = function () {
            resizeCanvas();
        };

        newSolarSystemBtn.addEventListener('click', generateNewSolarSystem);
        launchButton.addEventListener('click', launchCrab);
        window.addEventListener('resize', resizeCanvas);

        startGameBtn.addEventListener('click', function () {
            introPopup.style.display = 'none';
            launchButton.disabled = false;
            resizeCanvas();
        });
    </script>
</body>
</html>